name: Main Branch CI/CD (Build & Deploy)

on:
  push:
    branches: [ "main" ]
  # main은 보통 PR Merge로 들어오므로 pull_request 트리거는 굳이 필요 없지만,
  # PR 단계에서 빌드가 되는지 미리 보고 싶다면 추가해도 됩니다.
  
permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        # Vue 프로젝트 빌드 (dist 폴더 생성). 여기서 에러 나면 배포 중단됨.
        run: npm run build

      # --- 여기부터 배포(CD) 시작 ---
      
      - name: AWS 자격 증명 설정
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: ECR 로그인
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker Build & Push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: matchmeal-frontend
          IMAGE_TAG: latest # 혹은 ${{ github.sha }} 로 버전 관리 가능
        run: |
          # Dockerfile이 있는 위치에서 빌드
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Zip Deploy Files
        # 배포에 필요한 설정 파일들만 압축
        run: zip -r deploy.zip appspec.yml scripts docker-compose.yml nginx

      - name: S3 Upload & Deploy Trigger
        run: |
          aws s3 cp deploy.zip s3://matchmeal-deploy/frontend/deploy.zip

          echo ">>> AWS 승인 대기중이라 CodeDeploy 요청은 건너뜁니다."
          
        # aws deploy create-deployment \
        #   --application-name MatchMeal-App \
        #   --deployment-group-name MatchMeal-Dev-Group \
        #   --s3-location bucket=[본인의-S3-버킷],key=frontend/deploy.zip,bundleType=zip
